#SPDX-License-Identifier: MIT-0
---
# tasks file for continuwuity

- name: Add Continuwuity repository
  ansible.builtin.deb822_repository:
    name: continuwuity
    types: [deb]
    uris: https://forgejo.ellis.link/api/packages/continuwuation/debian/
    suites: ["{{ ansible_facts['distribution_release'] }}"]
    components: [stable]
    architectures: [amd64]
    signed_by: https://forgejo.ellis.link/api/packages/continuwuation/debian/repository.key
    enabled: true

- name: Install Continuwuity package
  apt:
    name: "{{ continuwuity_package }}"
    state: present
    update_cache: true

- name: Configure Continuwuity
  community.general.ini_file:
    path: /etc/conduwuit/conduwuit.toml
    section: global
    option: "{{item.option}}"
    value: "{{item.value}}"
  loop:
    - { option: "server_name", value: "\"{{ matrix_domain }}\"" }
    - { option: "port", value: "{{ continuwuity_listen_port }}" }
  notify: Restart Continuwuity

- name: Register Continuwuity bot user with Synapse
  command: >
    register_new_matrix_user
    --user {{ continuwuity_user.split(':')[0] | regex_replace('^@', '') }}
    --password {{ continuwuity_password }}
    --no-admin
    -k {{ matrix_registration_shared_secret }}
    {{ synapse_client_api }}
  register: register_output
  changed_when: "'Success' in register_output.stdout"
  failed_when: false

- name: Extract access token for Continuwuity bot
  command: >
    curl -s -XPOST -d '{"type":"m.login.password","user":"{{ continuwuity_user.split(':')[0] | regex_replace('^@', '') }}","password":"{{ continuwuity_password }}"}'
    {{ synapse_client_api }}/_matrix/client/r0/login
  register: login_output
  changed_when: false

- name: Parse access token
  set_fact:
    continuwuity_access_token: "{{ (login_output.stdout | from_json).access_token }}"



- name: Ensure Continuwuity service is enabled and running
  service:
    name: "{{ continuwuity_service_name }}"
    state: started
    enabled: true
