#SPDX-License-Identifier: MIT-0
---
# tasks file for nginx_matrix_proxy

- name: Ensure Nginx is installed
  ansible.builtin.package:
    name: nginx
    state: present
    update_cache: true

- name: Ensure Certbot is installed
  ansible.builtin.package:
    name: certbot
    state: present

- name: Ensure certbot webroot directory exists
  ansible.builtin.file:
    path: "{{ certbot_webroot }}"
    state: directory
    mode: '0755'
    owner: www-data
    group: www-data

- name: Check if certificate already exists
  stat:
    path: "/etc/letsencrypt/live/{{ matrix_domain }}/privkey.pem"
  register: cert_exists

- name: Deploy temporary ACME challenge config
  ansible.builtin.copy:
    dest: "{{ nginx_matrix_conf }}"
    mode: '0644'
    content: |
      server {
          listen 80;
          server_name {{ matrix_domain }};

          location /.well-known/acme-challenge/ {
              root {{ certbot_webroot }};
          }
      }
  when: not cert_exists.stat.exists
  notify: Reload Nginx

- name: Enable temporary site
  ansible.builtin.file:
    src: "{{ nginx_matrix_conf }}"
    dest: "{{ nginx_sites_enabled }}/{{ matrix_domain }}"
    state: link
  when: not cert_exists.stat.exists
  notify: Reload Nginx

- name: Wait for Nginx to reload
  ansible.builtin.pause:
    seconds: 4
  when: not cert_exists.stat.exists

- name: Request Let's Encrypt certificate
  ansible.builtin.command: >
    certbot certonly --webroot
    -w {{ certbot_webroot }}
    -d {{ matrix_domain }}
    --email {{ certbot_email }}
    --agree-tos
    --non-interactive
  when: not cert_exists.stat.exists
  register: certbot_result
  changed_when: "'Successfully received certificate' in certbot_result.stdout"

- name: Install certbot renewal hook for nginx
  ansible.builtin.copy:
    dest: /etc/letsencrypt/renewal-hooks/deploy/nginx-reload
    mode: '0755'
    content: |
      #!/bin/bash
      systemctl reload nginx

- name: Check if nftables is installed
  ansible.builtin.stat:
    path: /usr/sbin/nft
  register: nft_check

- name: Allow ports 80/443/8448 in nftables
  ansible.builtin.command: >
    nft add rule inet filter input tcp dport {{ item }} accept
  when: nft_check.stat.exists
  register: nft_http
  changed_when: "'added' in nft_http.stderr or 'add' in nft_http.stderr"
  failed_when: false
  loop:
    - 80
    - 443
    - 8448

- name: Deploy Nginx configs
  ansible.builtin.template:
    src: "{{ item }}.conf.j2"
    dest: "/etc/nginx/conf.d/{{ item }}.conf"
    mode: '0644'
  loop:
    - "{{ matrix_server_hostname }}"
    - "{{ matrix_domain }}"
    - "upstream"
  notify: Reload Nginx
